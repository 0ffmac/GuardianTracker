// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}


model User {
  id               String           @id @default(cuid())
  name             String?
  email            String           @unique
  emailVerified    DateTime?
  image            String?
  password         String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  // Privacy / preferences
  shareLocationWithTrustedContacts Boolean @default(true)
  /// If true, use Google 3D Maps on the dashboard when an API key is configured
  useGoogle3DMaps               Boolean @default(false)
  /// Optional per-user Google Maps API key (restrict via HTTP referrer in Google Cloud)
  googleMapsApiKey              String?
 
   accounts         Account[]

  devices          Device[]
  locations        Location[]
  mobileTokens     MobileSession[]
  pushTokens       PushToken[]
  sessions         Session[]
  trackingSessions TrackingSession[]
  trustedContacts  TrustedContact[] @relation("OwnerContacts")
  trustedBy        TrustedContact[] @relation("ContactUsers")
   alerts           Alert[]          // Alerts created by this user
   alertRecipients  AlertRecipient[] // Alerts this user has received
   sentAudioMessages AudioMessage[]  @relation("AudioSender") // Audio messages sent by this user
   receivedAudioMessages AudioMessage[] @relation("AudioReceiver") // Audio messages received by this user

   // WebRTC call relations
   outgoingCalls CallSession[] @relation("CallerSessions")
   incomingCalls CallSession[] @relation("CalleeSessions")
   callIceCandidates CallIceCandidate[] @relation("UserCallIceCandidates")
 }


model TrustedContact {
  id        String   @id @default(cuid())
  ownerId   String
  contactId String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())

  /// If true, this contact should receive emergency alerts
  receiveEmergencyAlerts Boolean @default(true)
  /// If true, this contact can be used for direct calls/messages
  allowCallsAndMessages Boolean @default(true)

  owner   User @relation("OwnerContacts", fields: [ownerId], references: [id], onDelete: Cascade)
  contact User @relation("ContactUsers", fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([ownerId, contactId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Device {
  id         String     @id @default(cuid())
  deviceId   String     @unique
  deviceName String
  platform   String
  lastSeen   DateTime   @default(now())
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  userId     String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations         Location[]         @relation("DeviceLocations")
  deviceObservations DeviceObservation[] @relation("DeviceDeviceObservations")
  trackedDevices     TrackedDevice[]     @relation("DeviceTrackedDevices")

  @@index([userId])
  @@index([deviceId])
}

model MobileSession {
  id           String   @id @default(cuid())
  token        String   @unique
  deviceId     String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([deviceId])
}

model Location {
  id                String           @id @default(cuid())
  latitude          Float
  longitude         Float
  accuracy          Float?
  altitude          Float?
  speed             Float?
  timestamp         DateTime         @default(now())
  userId            String
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId          String?
  device            Device?          @relation("DeviceLocations", fields: [deviceId], references: [id], onDelete: Cascade)
  trackingSessionId String?
  trackingSession   TrackingSession? @relation("SessionLocations", fields: [trackingSessionId], references: [id], onDelete: SetNull)
  wifiScans         WifiScan[]
  bleScans          BleScan[]

  @@index([userId])
  @@index([deviceId])
  @@index([timestamp])
  @@index([trackingSessionId])
}



model WifiScan {
  id         String   @id @default(cuid())
  ssid       String
  bssid      String
  rssi       Int
  frequency  Int?
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
}

model BleScan {
  id         String   @id @default(cuid())
  name       String?
  address    String
  rssi       Int
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
}

 model TrackingSession {
  id        String     @id @default(cuid())
  name      String?
  startTime DateTime
  endTime   DateTime
  userId    String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations         Location[]         @relation("SessionLocations")
  deviceObservations DeviceObservation[] @relation("SessionDeviceObservations")

  @@index([userId])
 }
 
  model DeviceObservation {
  id                String           @id @default(cuid())
  userDeviceId      String
  userDevice        Device           @relation("DeviceDeviceObservations", fields: [userDeviceId], references: [id], onDelete: Cascade)
  trackingSessionId String?
  trackingSession   TrackingSession? @relation("SessionDeviceObservations", fields: [trackingSessionId], references: [id], onDelete: Cascade)
  type              String
  identifier        String
  name              String?
  rssi              Int
  latitude          Float
  longitude         Float
  timestamp         DateTime         @default(now())

  @@index([userDeviceId, type, identifier])
  @@index([timestamp])
 }

 model TrackedDevice {
  id                     String        @id @default(cuid())
  userDeviceId           String
  userDevice             Device        @relation("DeviceTrackedDevices", fields: [userDeviceId], references: [id], onDelete: Cascade)
  type                   String
  identifier             String
  lastName               String?
  firstSeenAt            DateTime
  lastSeenAt             DateTime
  totalSightings         Int           @default(0)
  distinctLocationCount  Int           @default(0)
  suspicionScore         Float         @default(0)
  isSuspicious           Boolean       @default(false)
  devicePlaces           DevicePlace[]

  @@unique([userDeviceId, type, identifier], name: "userDeviceId_type_identifier")
  @@index([userDeviceId, type, identifier])
 }

 model DevicePlace {
  id             String        @id @default(cuid())
  trackedDeviceId String
  trackedDevice  TrackedDevice @relation(fields: [trackedDeviceId], references: [id], onDelete: Cascade)
  placeKey       String
  firstSeenAt    DateTime
  lastSeenAt     DateTime
  count          Int           @default(0)

  @@unique([trackedDeviceId, placeKey], name: "trackedDeviceId_placeKey")
  @@index([placeKey])
 }

 model Alert {

  id          String   @id @default(cuid())
  userId      String   // Person who triggered the alert
  title       String   // "Emergency Alert", "Help Request", etc.
  description String?  // Optional details
  status      String   @default("ACTIVE") // ACTIVE, RESOLVED, DISMISSED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationship to the user who triggered the alert
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relationships to trusted contacts who will receive the alert
  alertRecipients AlertRecipient[]

  // Audio messages related to this alert
  audioMessages AudioMessage[]
}

model AlertRecipient {
  id         String   @id @default(cuid())
  alertId    String
  contactId  String   // The contact who receives the alert
  status     String   @default("PENDING") // PENDING, READ, RESPONDED
  notifiedAt DateTime?
  respondedAt DateTime?
  createdAt  DateTime @default(now())

  alert   Alert @relation(fields: [alertId], references: [id], onDelete: Cascade)
  contact User  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([alertId, contactId])
}

 model AudioMessage {
   id         String   @id @default(cuid())
   alertId    String
   senderId   String   // Who sent the audio message
   receiverId String?  // Who is the intended recipient (nullable for broadcast)
   contentUrl String   // URL to the audio file
   contentType String  @default("audio/webm") // MIME type
   duration   Float?   // Duration in seconds
   status     String   @default("SENT") // SENT, DELIVERED, READ
   createdAt  DateTime @default(now())
 
   alert    Alert @relation(fields: [alertId], references: [id], onDelete: Cascade)
   sender   User  @relation("AudioSender", fields: [senderId], references: [id], onDelete: Cascade)
   receiver User? @relation("AudioReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
 
   @@index([alertId])
   @@index([senderId])
   @@index([receiverId])
 }
 
  model PushToken {
    id        String   @id @default(cuid())
    userId    String
    deviceId  String
    token     String   @unique
    platform  String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
  
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
    @@index([userId])
    @@index([deviceId])
  }

  /// WebRTC call session for 1:1 audio/video
  model CallSession {
    id        String   @id @default(cuid())
    callerId  String
    calleeId  String
    status    String   @default("RINGING") // RINGING, IN_PROGRESS, ENDED, DECLINED, MISSED
    offerSdp  String?
    answerSdp String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    caller User @relation("CallerSessions", fields: [callerId], references: [id], onDelete: Cascade)
    callee User @relation("CalleeSessions", fields: [calleeId], references: [id], onDelete: Cascade)
    iceCandidates CallIceCandidate[]

    @@index([callerId])
    @@index([calleeId])
  }

  /// Individual ICE candidates exchanged between peers
  model CallIceCandidate {
    id        String   @id @default(cuid())
    callId    String
    fromUserId String
    candidate String
    sdpMid    String?
    sdpMLineIndex Int?
    createdAt DateTime @default(now())

    call   CallSession @relation(fields: [callId], references: [id], onDelete: Cascade)
    fromUser User      @relation("UserCallIceCandidates", fields: [fromUserId], references: [id], onDelete: Cascade)

    @@index([callId])
    @@index([fromUserId])
  }